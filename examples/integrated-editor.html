<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MidiMind - Integrated MIDI Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ecf0f1;
            overflow: hidden;
        }

        .app-header {
            background: #2c3e50;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #34495e;
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        .toolbar {
            background: #34495e;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #2c3e50;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #2ecc71;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        .sidebar {
            width: 300px;
            background: #2c3e50;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #34495e;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            margin-bottom: 15px;
            color: #3498db;
            font-size: 14px;
            text-transform: uppercase;
        }

        .device-list {
            list-style: none;
        }

        .device-item {
            background: #34495e;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .device-item:hover {
            background: #3d566e;
        }

        .device-item.active {
            background: #3498db;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #2c3e50;
        }

        .piano-roll-container {
            flex: 1;
            padding: 20px;
            overflow: hidden;
        }

        .controls-panel {
            background: #34495e;
            padding: 15px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            border-top: 1px solid #2c3e50;
        }

        .info-panel {
            background: #2c3e50;
            padding: 10px 20px;
            font-size: 12px;
            color: #95a5a6;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            background: #3498db;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .file-label:hover {
            background: #2980b9;
        }

        select {
            background: #2c3e50;
            color: white;
            border: 1px solid #34495e;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        .log {
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 4px;
            margin-top: 10px;
        }

        .log-entry {
            margin-bottom: 4px;
            color: #95a5a6;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        .log-entry.success {
            color: #2ecc71;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-group label {
            font-size: 12px;
            min-width: 80px;
        }

        input[type="range"] {
            flex: 1;
            max-width: 200px;
        }

        .value-display {
            min-width: 40px;
            text-align: right;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="app-header">
        <div class="app-title">üéπ MidiMind - Integrated MIDI Editor</div>
        <div class="status-bar">
            <div>
                <span class="status-dot" id="ws-status"></span>
                <span id="ws-text">WebSocket</span>
            </div>
            <div>
                <span class="status-dot" id="midi-status"></span>
                <span id="midi-text">WebMIDI</span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <label class="file-label">
            üìÅ Open MIDI
            <input type="file" id="file-input" accept=".mid,.midi">
        </label>
        <button class="btn btn-success" id="btn-play">‚ñ∂ Play</button>
        <button class="btn" id="btn-stop">‚èπ Stop</button>
        <button class="btn btn-danger" id="btn-panic">üö® Panic</button>
        <button class="btn" id="btn-clear">üóë Clear</button>
        <div style="flex: 1"></div>
        <div class="slider-group">
            <label>BPM:</label>
            <input type="range" id="bpm-slider" min="60" max="200" value="120">
            <span class="value-display" id="bpm-value">120</span>
        </div>
        <div class="slider-group">
            <label>Volume:</label>
            <input type="range" id="volume-slider" min="-60" max="0" value="-10">
            <span class="value-display" id="volume-value">-10</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>Browser MIDI Inputs</h3>
                <ul class="device-list" id="browser-inputs">
                    <li style="color: #7f8c8d; font-size: 12px;">No devices found</li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Browser MIDI Outputs</h3>
                <ul class="device-list" id="browser-outputs">
                    <li style="color: #7f8c8d; font-size: 12px;">No devices found</li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Backend MIDI Devices</h3>
                <ul class="device-list" id="backend-devices">
                    <li style="color: #7f8c8d; font-size: 12px;">Not connected</li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Settings</h3>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="checkbox" id="audio-preview" checked>
                    <span style="font-size: 12px;">Audio Preview</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="loop-playback">
                    <span style="font-size: 12px;">Loop Playback</span>
                </label>
            </div>

            <div class="sidebar-section">
                <h3>Activity Log</h3>
                <div class="log" id="activity-log"></div>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="editor-container">
            <div class="piano-roll-container" id="piano-roll-container">
                <!-- Piano Roll will be inserted here -->
            </div>

            <div class="info-panel">
                <span id="info-text">Ready. Load a MIDI file or start drawing notes.</span>
            </div>
        </div>
    </div>

    <!-- External Libraries (CDN) -->
    <script src="../public/js/lib/external-libs.js"></script>

    <!-- Our Integration Layer -->
    <script src="../public/js/services/EnhancedWebSocketClient.js"></script>
    <script src="../public/js/bridges/MidiBridge.js"></script>
    <script src="../public/js/wrappers/PianoRollWrapper.js"></script>
    <script src="../public/js/integration/MidiIntegrationManager.js"></script>

    <!-- Application Script -->
    <script>
        let manager = null;
        let pianoRoll = null;
        const eventBus = {
            listeners: {},
            on(event, handler) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(handler);
            },
            off(event, handler) {
                if (!this.listeners[event]) return;
                this.listeners[event] = this.listeners[event].filter(h => h !== handler);
            },
            emit(event, data) {
                if (!this.listeners[event]) return;
                this.listeners[event].forEach(h => h(data));
            }
        };

        // ====================================================================
        // INITIALIZATION
        // ====================================================================

        async function init() {
            log('Initializing application...');

            try {
                // Create integration manager
                manager = new MidiIntegrationManager(eventBus);

                // Initialize (loads external libs, connects WebSocket, etc.)
                await manager.init('ws://localhost:8081');

                // Update status indicators
                updateStatus();

                // Create piano roll
                pianoRoll = manager.createPianoRoll('#piano-roll-container', {
                    width: document.querySelector('.piano-roll-container').clientWidth - 40,
                    height: document.querySelector('.piano-roll-container').clientHeight - 40,
                    timebase: 16,
                    editmode: 'dragpoly',
                    wheelzoom: 1
                });

                log('‚úÖ Application ready', 'success');
                updateInfo('Ready. Load a MIDI file or draw notes on the piano roll.');

                // Load demo notes
                loadDemoSequence();

            } catch (error) {
                log('‚ùå Initialization error: ' + error.message, 'error');
                console.error(error);
            }
        }

        // ====================================================================
        // EVENT HANDLERS
        // ====================================================================

        // File input
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                log(`Loading file: ${file.name}`);
                await manager.loadMidiFile(file);
                log('‚úÖ File loaded successfully', 'success');
                updateInfo(`Loaded: ${file.name}`);
            } catch (error) {
                log('‚ùå Error loading file: ' + error.message, 'error');
            }
        });

        // Play button
        document.getElementById('btn-play').addEventListener('click', () => {
            try {
                manager.playPianoRoll();
                log('‚ñ∂ Playback started');
            } catch (error) {
                log('‚ùå Playback error: ' + error.message, 'error');
            }
        });

        // Stop button
        document.getElementById('btn-stop').addEventListener('click', () => {
            manager.stopPianoRoll();
            log('‚èπ Playback stopped');
        });

        // Panic button
        document.getElementById('btn-panic').addEventListener('click', () => {
            manager.panic();
            log('üö® MIDI Panic (all notes off)');
        });

        // Clear button
        document.getElementById('btn-clear').addEventListener('click', () => {
            if (confirm('Clear all notes?')) {
                pianoRoll.clear();
                log('Notes cleared');
            }
        });

        // BPM slider
        document.getElementById('bpm-slider').addEventListener('input', (e) => {
            const bpm = parseInt(e.target.value);
            document.getElementById('bpm-value').textContent = bpm;
            if (pianoRoll) {
                pianoRoll.setBPM(bpm);
            }
        });

        // Volume slider
        document.getElementById('volume-slider').addEventListener('input', (e) => {
            const volume = parseInt(e.target.value);
            document.getElementById('volume-value').textContent = volume;
            if (manager) {
                manager.setMasterVolume(volume);
            }
        });

        // Audio preview toggle
        document.getElementById('audio-preview').addEventListener('change', (e) => {
            if (manager) {
                manager.setAudioPreview(e.target.checked);
                log(e.target.checked ? 'Audio preview enabled' : 'Audio preview disabled');
            }
        });

        // Loop playback toggle
        document.getElementById('loop-playback').addEventListener('change', (e) => {
            if (pianoRoll) {
                pianoRoll.setLoop(e.target.checked);
                log(e.target.checked ? 'Loop enabled' : 'Loop disabled');
            }
        });

        // ====================================================================
        // EVENT BUS LISTENERS
        // ====================================================================

        eventBus.on('midi:devices_changed', (devices) => {
            updateDeviceLists(devices);
        });

        eventBus.on('midi:message', (data) => {
            // Log MIDI activity (throttled)
            const bytes = data.data.map(b => b.toString(16).padStart(2, '0')).join(' ');
            // log(`MIDI: ${bytes}`, 'info');
        });

        // ====================================================================
        // UI HELPERS
        // ====================================================================

        function updateStatus() {
            const status = manager.getStatus();

            // WebSocket status
            const wsStatus = document.getElementById('ws-status');
            const wsText = document.getElementById('ws-text');
            if (status.websocket?.connected) {
                wsStatus.classList.add('connected');
                wsText.textContent = 'WebSocket (Connected)';
            } else {
                wsStatus.classList.remove('connected');
                wsText.textContent = 'WebSocket (Offline)';
            }

            // MIDI status
            const midiStatus = document.getElementById('midi-status');
            const midiText = document.getElementById('midi-text');
            if (status.midibridge) {
                midiStatus.classList.add('connected');
                midiText.textContent = `WebMIDI (${status.midibridge.browserInputs} in, ${status.midibridge.browserOutputs} out)`;
            } else {
                midiStatus.classList.remove('connected');
                midiText.textContent = 'WebMIDI (Not available)';
            }
        }

        function updateDeviceLists(devices) {
            // Browser inputs
            const browserInputsList = document.getElementById('browser-inputs');
            browserInputsList.innerHTML = '';
            if (devices.browser.inputs.length === 0) {
                browserInputsList.innerHTML = '<li style="color: #7f8c8d; font-size: 12px;">No devices found</li>';
            } else {
                devices.browser.inputs.forEach(device => {
                    const li = document.createElement('li');
                    li.className = 'device-item';
                    li.textContent = device.name;
                    li.onclick = () => {
                        manager.connectBrowserInput(device.id);
                        log(`Connected: ${device.name}`, 'success');
                    };
                    browserInputsList.appendChild(li);
                });
            }

            // Browser outputs
            const browserOutputsList = document.getElementById('browser-outputs');
            browserOutputsList.innerHTML = '';
            if (devices.browser.outputs.length === 0) {
                browserOutputsList.innerHTML = '<li style="color: #7f8c8d; font-size: 12px;">No devices found</li>';
            } else {
                devices.browser.outputs.forEach(device => {
                    const li = document.createElement('li');
                    li.className = 'device-item';
                    li.textContent = device.name;
                    browserOutputsList.appendChild(li);
                });
            }

            // Backend devices
            const backendList = document.getElementById('backend-devices');
            backendList.innerHTML = '';
            const backendDevices = [...devices.backend.inputs, ...devices.backend.outputs];
            if (backendDevices.length === 0) {
                backendList.innerHTML = '<li style="color: #7f8c8d; font-size: 12px;">No devices found</li>';
            } else {
                backendDevices.forEach(device => {
                    const li = document.createElement('li');
                    li.className = 'device-item';
                    li.textContent = `${device.name} (${device.type})`;
                    backendList.appendChild(li);
                });
            }
        }

        function updateInfo(text) {
            document.getElementById('info-text').textContent = text;
        }

        function log(message, type = 'info') {
            const logEl = document.getElementById('activity-log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${time}] ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);

            // Keep only last 50 entries
            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.lastChild);
            }
        }

        function loadDemoSequence() {
            if (!pianoRoll) return;

            // C major scale
            const sequence = [
                [0, 60, 4, 100],  // C
                [4, 62, 4, 100],  // D
                [8, 64, 4, 100],  // E
                [12, 65, 4, 100], // F
                [16, 67, 4, 100], // G
                [20, 69, 4, 100], // A
                [24, 71, 4, 100], // B
                [28, 72, 8, 100]  // C
            ];

            pianoRoll.setSequence(sequence);
            log('Demo sequence loaded');
        }

        // ====================================================================
        // START
        // ====================================================================

        window.addEventListener('load', () => {
            init();
        });

        // Prevent accidental navigation away
        window.addEventListener('beforeunload', (e) => {
            if (pianoRoll && pianoRoll.getSequence().length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
